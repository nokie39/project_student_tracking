เปเบเปเบเบญเบ! เบเบตเปเบเบท **เปเบเบเบเบฒเบเบญเบฑเบเปเบเบเบฅเบฐเบเบปเบ (Migration Plan)** เบเบตเปเบชเบฑเบเบฅเบงเบกเบชเบดเปเบเบเบตเปเปเบฎเบปเบฒเปเบเปเปเบเปเบเบเบฑเบเปเบปเบ เปเบเบทเปเบญเปเบซเปเบเปเบฒเบเบเบณเปเบเปเบเป Deploy เบเบถเปเบ Server เปเบเปเบขเปเบฒเบเปเบฑเปเบเปเบ.

เบเปเบฒเบเบชเบฒเบกเบฒเบ Save เปเบเบทเปเบญเบซเบฒเบเบตเปเปเบเบฑเบเปเบเบฅเป `MIGRATION_PLAN.md` เปเบเบฑเบเปเบงเปเปเบ Project เปเบเปเปเบฅเบตเบ.

---

# ๐ Migration Plan: Student Tracking System (v1.0 Stable)

เปเบญเบเบฐเบชเบฒเบเบเบตเปเบชเบฑเบเบฅเบงเบกเบเบฑเปเบเบเบญเบเบเบฒเบเบญเบฑเบเปเบเบเบฅเบฐเบเบปเบ Backend เปเบฅเบฐ Database เปเบเบทเปเบญเปเบเปเปเบเบเบฑเบเบซเบฒ Validation Error, เบเบฑเบเบซเบฒเบเบฒเบเบฅเบถเบเบเปเปเบกเบนเบ เปเบฅเบฐ เบเบฒเบเบชเบฐเปเบเบเบเบปเบเบเบตเปเบเปเปเบเบปเบเบเปเบงเบ.

---

## ๐ฆ Phase 1: Codebase Updates (เบญเบฑเบเปเบเบเปเบเบ)

เบเปเบญเบเบเบฐ Deploy, เปเบซเปเบเบงเบเบชเบญเบเบงเปเบฒเปเบเบฅเปเปเบซเบผเบปเปเบฒเบเบตเปเปเบเปเบฎเบฑเบเบเบฒเบเปเบเปเปเบเบฅเปเบฒเบชเบธเบเปเบฅเปเบง:

### 1. `student_tracking_backend/schemas.py` (Critical Fix)

**เปเบเบปเปเบฒเปเบฒเบ:** เปเบเปเปเบ `ResponseValidationError` เปเบเบเบเบฒเบเปเบฎเบฑเบเปเบซเป Field เบเปเบฒเบเปเบฎเบฑเบเบเปเบฒ NULL เปเบเป (Safe Mode).

* [x] **ClassResponse:** เบเปเบฝเบ `teacher_id`, `year_id` เปเบเบฑเบ `Optional[int]`.
* [x] **ClassResponse:** เปเบเบตเปเบก `enrollments` List เปเบเบทเปเบญเบฎเบฑเบเบฅเบฒเบเบเบทเปเบเบฑเบเบฎเบฝเบ.
* [x] **StudentSimple:** เปเบเบตเปเบก Schema เบเบตเปเปเบฅเบฐเบเบฑเปเบ `student_code` เปเบเบฑเบ `Optional`.
* [x] **AcademicYear & Enrollment:** เบเบฑเปเบเบเปเบฒ `Optional` เปเบซเปเบเบฑเบ Field เบเบตเปเบเบณเปเบเบฑเบ.

### 2. `student_tracking_backend/routers/academic.py`

**เปเบเบปเปเบฒเปเบฒเบ:** เบเบถเบเบเปเปเบกเบนเบเปเบซเปเบเบปเบ เปเบฅเบฐ เปเบเปเปเบเบเบฒเบเบฅเบถเบเบซเปเบญเบเบฎเบฝเบ.

* [x] **Function `get_all_classes`:** เปเบเบตเปเบก `joinedload(models.Class.enrollments)` เปเบฅเบฐ `joinedload(models.Class.academic_year)`.
* [x] **Function `delete_class`:** (Optional) เปเบเบตเปเบก Logic เบฅเบถเบเบเปเปเบกเบนเบเบเบตเปเบเปเบฝเบงเบเปเบญเบ (Cascade Delete) เบเปเบฒเบเปเบญเบเบเบฒเบเบฅเบถเบเบซเปเบญเบเบเบตเปเบกเบตเบเบฑเบเบฎเบฝเบ.

### 3. `student_tracking_backend/models.py`

**เปเบเบปเปเบฒเปเบฒเบ:** เบเบงเบเบชเบญเบเบเบงเบฒเบกเบเบทเบเบเปเบญเบเบเบญเบ Database Model.

* [x] เบเบงเบเบชเบญเบ Relationship เบฅเบฐเบซเบงเปเบฒเบ `Class` <-> `AcademicYear` เปเบฅเบฐ `Class` <-> `Enrollment`.

---

## ๐๏ธ Phase 2: Database Migration (เบญเบฑเบเปเบเบเบเบฒเบเบเปเปเบกเบนเบ)

เปเบเบทเปเบญเบเบเบฒเบเบกเบตเบเบฒเบเบเปเบฝเบเปเบเบ Logic เบเบฒเบเบขเปเบฒเบ (เปเบเบฑเปเบ: เบเบฒเบเบเบญเบกเบฎเบฑเบเบเปเบฒ NULL), เบเบฒเบเบเปเปเบกเบนเบเบเปเบญเบเบชเบญเบเบเปเบญเบเบเบฑเบ Code.

### เบเบฒเบเปเบฅเบทเบญเบ A: เบเปเบฒเบเบฑเบเปเบเบฑเบเบฅเบฐเบเบปเบเบเบปเบเบชเบญเบ (Recommended for Dev)

เบงเบดเบเบตเบเบตเปเบเปเบฒเบเบเบตเปเบชเบธเบเบเบทเบเบฒเบ **Reset Database** เปเปเป (เบเปเปเบกเบนเบเบเบฐเบซเบฒเบเปเบปเบ).

1. เปเบเบปเปเบฒเปเบเบเบตเป Google Cloud Console (SQL).
2. เบฅเบถเบ Database `student_tracking` เปเบเบปเปเบฒเบเบดเปเบก.
3. เบชเปเบฒเบ Database `student_tracking` เปเปเป.
4. Restart Service Cloud Run -> เบฅเบฐเบเบปเบเบเบฐเบชเปเบฒเบ Table เปเปเปเปเบซเปเบญเบฑเบเบเบฐเปเบเบกเบฑเบ (เบเปเบฒเบ `models.Base.metadata.create_all`).

### เบเบฒเบเปเบฅเบทเบญเบ B: เบเปเบฒเปเบเบฑเบ Production (เบกเบตเบเปเปเบกเบนเบเบชเบณเบเบฑเบ)

เบเปเบญเบเปเบเป SQL Command เปเบเปเปเบเปเบเบเบชเปเบฒเบ (Manual Migration) เบเปเบฒเบเปเบเบทเปเบญเบเบกเบทเปเบเบฑเปเบ pgAdmin เบซเบผเบท Cloud Shell:

```sql
-- 1. เบเปเบฝเบเปเบซเป student_code เบฎเบฑเบเบเปเบฒ NULL เปเบเป (เบเปเบฒเบเบณเปเบเบฑเบ)
ALTER TABLE students ALTER COLUMN student_code DROP NOT NULL;

-- 2. เบเปเบฝเบเปเบซเป teacher_id เปเบ classes เบฎเบฑเบเบเปเบฒ NULL เปเบเป
ALTER TABLE classes ALTER COLUMN teacher_id DROP NOT NULL;

-- 3. เบเปเบฝเบเปเบซเป year_id เปเบ classes เบฎเบฑเบเบเปเบฒ NULL เปเบเป
ALTER TABLE classes ALTER COLUMN year_id DROP NOT NULL;

```

---

## โ๏ธ Phase 3: Backend Deployment (Google Cloud Run)

เบซเบผเบฑเบเบเบฒเบ Code เปเบฅเบฐ Database เบเปเบญเบกเปเบฅเปเบง เปเบซเป Deploy Backend เปเปเป.

**Step 1: Build Container Image**

```bash
cd student_tracking_backend
gcloud builds submit --tag gcr.io/[PROJECT_ID]/student-api

```

**Step 2: Deploy to Cloud Run**

```bash
gcloud run deploy student-api \
  --image gcr.io/[PROJECT_ID]/student-api \
  --platform managed \
  --region us-central1 \
  --allow-unauthenticated \
  --set-env-vars DATABASE_URL="postgresql://user:pass@/dbname?host=/cloudsql/..."

```

---

## ๐ฅ๏ธ Phase 4: Frontend Deployment (Firebase Hosting)

เบญเบฑเบเปเบเบเปเปเบฒเปเบงเบฑเบเปเบซเปเบฎเบญเบเบฎเบฑเบเบเบฒเบเบเปเบฝเบเปเบเบ.

**Step 1: Build Project**

```bash
cd frontend_school_admin
npm run build

```

*(เบเบงเบเบชเบญเบเบงเปเบฒเบเปเปเบกเบต Error เปเบเบเบฑเปเบเบเบญเบเบเบตเป)*

**Step 2: Deploy**

```bash
firebase deploy

```

**Step 3: Clear Cache**

* เปเบเปเบเปเบซเป User เบเบปเบ `Ctrl + F5` เบซเบผเบท `Cmd + Shift + R` เปเบเบทเปเบญเปเบซเบผเบเปเบเบฅเป .js เปเปเป.

---

## โ Phase 5: Verification Checklist (เบเบงเบเบชเบญเบเบซเบผเบฑเบเบญเบฑเบเปเบเบ)

เบซเบผเบฑเบเบเบฒเบ Deploy เบชเบณเปเบฅเบฑเบ เปเบซเปเบเบปเบเบชเบญเบเบเบฒเบกเบฅเบฒเบเบเบฒเบเบเบตเป:

1. **Dashboard Load:**
* [ ] Login เปเบเบปเปเบฒเบฅเบฐเบเบปเบเปเบเป.
* [ ] Dashboard เบชเบฐเปเบเบเบเบปเบงเปเบฅเบเบชเบฐเบเบดเบเบดเบเบปเบเบเปเบงเบ (เบเปเปเปเบธเบเบเบดเปเบงเป).


2. **Class Management:**
* [ ] เปเปเบฒ "เบซเปเบญเบเบฎเบฝเบ" เบชเบฐเปเบเบเบฅเบฒเบเบเบทเปเบซเปเบญเบ + เบเบทเปเบเบน + เบเบตเบฎเบฝเบ เบเบปเบ.
* [ ] เบฅเบญเบเบชเปเบฒเบเบซเปเบญเบเบฎเบฝเบเปเปเป (เปเบชเปเบเปเปเบกเบนเบเบเปเปเบเบปเบ เปเบเบฑเปเบ: เบเปเปเปเบชเปเบเบน) -> เบเปเบญเบเบเปเป Error.
* [ ] เบฅเบญเบเบฅเบถเบเบซเปเบญเบเบฎเบฝเบ -> เบเปเบญเบเบฅเบถเบเปเบเป (เบเปเบฒเปเบเป Logic เปเปเป) เบซเบผเบท เปเบเปเบเปเบเบทเบญเบ (เบเปเบฒเปเบเป Logic เปเบเบปเปเบฒ).


3. **Enrollment:**
* [ ] เปเบซเบฑเบเบเบณเบเบงเบเบเบฑเบเบฎเบฝเบเปเบเปเบเปเบฅเบฐเบซเปเบญเบ.
* [ ] เบฅเบฒเบเบเบทเปเบเบฑเบเบฎเบฝเบเบชเบฐเปเบเบเบเบทเบเบเปเบญเบ.



---

### ๐ Troubleshooting (เบเบฒเบเปเบเปเบเบฑเบเบซเบฒเบชเบฐเปเบเบฒเบฐเปเปเบฒ)

* **Error 500 (Internal Server Error):**
* เบเบงเบเบชเบญเบ Logs เปเบ Cloud Run.
* เบชเปเบงเบเบซเบผเบฒเบเปเบเบตเบเบเบฒเบ `DATABASE_URL` เบเบดเบ เบซเบผเบท `schemas.py` เบเปเปเบเบปเบเบเบฑเบเบเปเปเบกเบนเบเปเบ DB.


* **Failed to fetch dynamically imported module:**
* เปเบเบตเบเบเบตเป Frontend. เปเบซเป Refresh browser เปเบฎเบเป (Hard Refresh).


* **CORS Error:**
* เบเบงเบเบชเบญเบ `main.py` เบงเปเบฒ `allow_origins=["*"]` เปเบฎเบฑเบเบงเบฝเบเบขเบนเป.